# Knowledge Graph dataset


# Overview
Dataset of images & sequence metadata. Sequence metadata is converted to Question-Answer pairs in JSON format. Optionally, additional data e.g. segmentation data can be included.


This dataset can by utilized for [Retrieval-Augmented Generation](https://repo.ijs.si/bkuster/rag_retrieval_augmented_generation) or for training a VLM or a classifier.

For an up-to-date format, check the **example_single_node_dataset** folder.

# Graph dataset format:

    training_data_folder/ 
    ├── graph_edges.csv # File containing the connections between nodes in the graph. 
    └── nodes/ # Directory containing data for each node. 
        └── device_0/ # Directory for a specific node, e.g., device_0. 
            ├── 0_0.jpg # Image of step 0, instance 0, associated with this node. 
            ├── 0_0.json # Segmentation data in LabelMe JSON format. 
            ├── 0_0_qa.json # Question-Answer pairs in JSON (script-generated).
            ├── 1_0.jpg # Image of step 1, instance 0, associated with this node.
            └── seq_metadata.json # JSON of sequence metadata used for generating QA pairs for RAG,
                # And training data for VLMs/classifiers.

**graph\_edges.csv** should contain comma-separated **parent\_node,child\_node** connections, e.g.
> device,smoke\_detector

It is used only for Retrieval-Augmented Generation using a Knowledge Graph, so for classification tasks you do not need to generate it.

# Single folder (node definition)

A folder (node) should contain a set of images (e.g. **0_0.jpg**), and a folder should also contain a sequence metadata JSON.

Example **sequence metadata JSON**:

        {
            "image_sequences": ["0_0.png"],
            "steps": ["flip"],
            "centered_object": "heat_cost_allocator_kalo"
        }
        

Image naming convention: The image name must consist of **{step_index}**_**{instance_index}**.(png|jpg|...).

Both step index and instance index MUST contain 2 digits (e.g. img 0: 00, img 1: 01).

The **step index** determines which (disassembly) action must be taken, e.g. 0 -> "flip", 1 -> "move", ... Index 0 is mapped to the 0-th step in the **steps** field of **sequence_metadata.json**.

The **instance_index** is a particular instance of a (device) image where the same step must be taken, i.e. several images can show a device, and in all cases, the same step must be taken. The images are then named **0_0.jpg, 0_1.jpg**, ...

Based on the **sequence metadata**, QA pair JSONs are generated by an included script.

Example generated **QA JSON**:


    [
        {
            "Q": "What device is shown?",
            "A": "Smoke detector Hekatron."
        },
        {
            "Q": "What is the next disassembly step?",
            "A": "Place into the CNC mill."
        }
    ]

# Conversion to dataset

Convert to dataset for training a classifier:

>     cd scripts
>     python3 convert_dataset_to_training_data.py --folder_to_parse '/knowledge_graph/datasets/train_knowledge_graph' --output_classification_json_full_path '/knowledge_graph/training_data_jsons/classification_data.json' --output_vlm_json_full_path '/knowledge_graph/training_data_jsons/vlm_data.json'

For the example dataset:

>     cd scripts
>     python3 convert_dataset_to_training_data.py --folder_to_parse '/knowledge_graph/example_single_node_dataset' --output_classification_json_full_path '/knowledge_graph/training_data_jsons/classification_data.json' --output_vlm_json_full_path '/knowledge_graph/training_data_jsons/vlm_data.json'

# OLD - Misc

Device components in image form can be found in: `~/datasets2/reconcycle/2023-05-23_synthetic_dataset/foregrounds_saved`. They are generated by [get_foregrounds.ipynb](https://gitlab.gwdg.de/sebastian.ruiz/synthetic-dataset-creator/-/blob/master/get_foregrounds.ipynb).

New images can be labelled using [Labelme with segment anything](https://github.com/originlake/labelme-with-segment-anything).

0\_qa.json files can be created using [knowledge_graph_generator.ipynb](https://github.com/ReconCycle/vision_pipeline/blob/dev/notebooks/knowledge_graph_generator.ipynb).


